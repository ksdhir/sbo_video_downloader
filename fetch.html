<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </head>

</head>
<body>

  <script>

    var fetchVideoContents = {

        type: "",

        useQuery: function (a, b) {
          var c = a.includes("?");
          if ("string" == typeof b) return a + (c ? "&" : "?") + b;
          for (var d in b) {
            var e = encodeURIComponent(b[d]); a += (c ? "&" : "?") + d + "=" + e, c = !0
          }
          return a;
        },
        prepareURL: function (currentURL) {
          var fetchURL = this.useQuery("https://api.videograbber.net/api/video", { uri: window.btoa(currentURL) });
          return fetchURL;
        },

        runAjax: function (currentURL,button) {
          this.type = button;
          let val = this.prepareURL(currentURL);
          $.ajax({
            type: "GET",
            dataType: "json",
            url: val,
            async: false,
            success: handleRequestSuccess.bind(this),
            error: function () { console.log('error!') }
          });


          function handleRequestSuccess(a) {
            if(a.data === null) {
              console.error("Video could not be processed");
              return;
            }
            var b = a.data;
            if (b && 1 == a.state) {
              this.renderData([b])
              // console.log([b]);
            }
          };

        },




        // the render data function
        renderData : function(b) {
        for (var c = b.length - 1; c >= 0; c--) {
          if ("string" == typeof b[c]) {
            try {
              b[c] = JSON.parse(b[c])
            }
            catch (d) {
              b.splice(c, 1)
            }
          }
        }
          // call the prepareData function
          this.prepareData(b);
          // call the renderWinData to make the table
          this.renderWinData(b);
        },

        prepareData: function(a) {
          var d = a[0];
          d.formats || (d.formats = [d]);
          for (var c = 0; c < d.formats.length; c++) {
            var f = d.formats[c];
            this.formatFile(d, f)
          }
          this.sortFormats(d.formats)
        },

        formatFile: function(b, c) {
          var d = c.format.match(/^\d+/), e = d ? Number(d[0]) : 0;
          [133, 134, 135, 136, 137, 138, 160, 264, 298, 299, 296].indexOf(e) > -1 ? (c.format = c.format.replace(/\s*\(.+?\)/g, "") + " (DASH video)", c.format_note = "DASH video") : [139, 140, 141, 171, 172].indexOf(e) > -1 && (c.format = c.format.replace(/\s*\(.+?\)/g, ""), c.format_note = "DASH audio"), c.formattedSize = this.measureSize(c.filesize) || "--", c.formattedQuality = this.formatQuality(c), c.videoAudioQuality = c.height ? c.height + "p" : c.abr ? c.abr + "Kbps" : "Unknown", c.downloadName = b._filename || b.title + "." + (c.ext || b.ext);
          var d = c.url.replace(/\?.+/, "").match("[^/]+?$");
        },
        
        measureSize : function (a) {
          if (!(a > 0)) return "";
          var b = ["B", "KB", "MB", "GB", "TB"];
          var c = parseInt(Math.floor(Math.log(a) / Math.log(1024)));
          var d = a / Math.pow(1024, c);
          return d = 10 > d ? d.toFixed(2) : 100 > d ? d.toFixed(1) : d.toFixed(0), d = d.replace(/\.0+$/, ""), d + " " + b[c];
        },
        
        formatQuality : function (a) {
          return (a.format || "").replace(/^\d+ - /, "");
        },

        sortFormats : function (a) {
          function b(a, b){
            return a || b ? a && b ? a === b ? 0 : b > a ? 1 : -1 : a ? -1 : 1 : 0
          }
          for (var c = ["mp4", "flv", "webm", "3gp", "m4a"], d = a.length - 1; d >= 0; d--) {
            var e = a[d], f = e.format_note;
            if ("DASH video" !== f) {
              var g = e.protocol;
              if (/m3u8|hls|native|rtmp|rtsp|f4m/.test(g)) {
                a.splice(d, 1);
              }
              else if (g || !/m3u8|hls|native|rtmp/.test(e.format)) {
                var h = e.url, i = /^https?:/.test(h), j = h.replace(/\?.+/, "").match(/\.\w+$/), k = j ? j[1] : ""; g || e.format || i && "m3u8" !== k && "f4m" !== k || a.splice(d, 1)
              }
              else a.splice(d, 1)
            }
            else a.splice(d, 1)
          }
          a.sort(function (a, d) {
            var e = c.indexOf(a.ext), f = c.indexOf(d.ext);

            if (e !== f) return -1 === e ? 1 : -1 === f ? -1 : e - f;

            var g = b(a.ext, d.ext);
            if (g) return g;
            var g = b(a.width, d.width);
            if (g) return g;
            if ("DASH audio" === a.format_note) {
              var g = b(a.abr, d.abr); if (g) return g
            }
            var g = b(a.filesize, d.filesize);
            return g ? g : void 0;
          })
        },


        renderWinData: function(c) {

          if(this.type == "course") {
            // don't need to render anything
            // continue the process with downloading the whole course
            
            // call the function to download
            
            return;
          }

          this.data = c;
          console.log(c);
          // i dunno how to use this shit
          //var d = c[0].webpage_url
          
          // The video title
          var e = c[0].title
          // The video length
          var f = this.formatDuration(c[0].duration)
          // The video thumbnail
          var g = c[0].thumbnail || (c[0].thumbnails ? c[0].thumbnails[0] : null)
          // The video formats
          var h = c.length > 1 || !c[0].formats


          // how many downloads have been made
          //var i = Number(c[0].view_count);

          //console.log(d);

          console.log(e);
          console.log(f);
          console.log(g);
          console.log(h);
          
          // no need of i
          //console.log(i);
        },

        formatDuration: function (a){
          if(!a)return "";
          var b = Math.floor(a / 3600), c = Math.floor(a % 3600 / 60) || 0, d = Math.floor(a % 60) || 0;
          return (b ? String(b).padLeft(2, "0") + ":" : "") + String(c).padStart(2, "0") + ":" + String(d).padStart(2, "0")
        }

      };
    
    
    // (function(){
      
      
    //   return fetchVideoContents;
    // })()


    
/*

    var val = useQuery("https://api.videograbber.net/api/video", { uri: window.btoa(theResource) });
    $.ajax({
        type:"GET",
        dataType:"json",
        url:val,
        success: handleRequestSuccess.bind(this),
        error: function(){console.log('error!')}
    })

    function handleRequestSuccess(a) {
        var b = a.data;
        if (b && 1 == a.state) {
          renderData([b])
        };
    }

    function renderData(b){
       for(var c=b.length-1;c>=0;c--) {
        if("string"==typeof b[c]) {
          try {
            b[c]=JSON.parse(b[c])
          }
          catch(d){
            b.splice(c,1)
          }
        }
      }

      prepareData(b);
      renderWinData(b);
    }

    function formatDuration (a){
      if(!a)return"";
  
    var b=Math.floor(a/3600),c=Math.floor(a%3600/60)||0,d=Math.floor(a%60)||0;
      return(b?String(b).padLeft(2,"0")+":":"")+String(c).padStart(2,"0")+":"+String(d).padStart(2,"0")
    }


    function renderWinData(c) {
      console.log(c);
      
        var d = c[0].webpage_url 
        var e = c[0].title
        var f = formatDuration(c[0].duration) 
        var g = c[0].thumbnail || (c[0].thumbnails ? c[0].thumbnails[0] : null) 
        var h = c.length > 1 || !c[0].formats 
        var i = Number(c[0].view_count);

        console.log(d);
        console.log(e);
        console.log(f);
        console.log(g);
        console.log(h);
        console.log(i);


    }

    function prepareData(a) {
      var d = a[0];
      d.formats || (d.formats = [d]);
      for (var c = 0; c < d.formats.length; c++) {
        var f = d.formats[c];
        formatFile(d, f)
      }
      sortFormats(d.formats) 
    }

    var measureSize = function (a) {
      if (!(a > 0)) return "";
      var b = ["B", "KB", "MB", "GB", "TB"];
      var c = parseInt(Math.floor(Math.log(a) / Math.log(1024)));
      var d = a / Math.pow(1024, c);
      return d = 10 > d ? d.toFixed(2) : 100 > d ? d.toFixed(1) : d.toFixed(0), d = d.replace(/\.0+$/, ""), d + " " + b[c];
    };

    function formatQuality(a) {
      return (a.format || "").replace(/^\d+ - /, "");
    }

    function formatFile(b,c) {
      var d = c.format.match(/^\d+/), e = d ? Number(d[0]) : 0;
      [133, 134, 135, 136, 137, 138, 160, 264, 298, 299, 296].indexOf(e) > -1 ? (c.format = c.format.replace(/\s*\(.+?\)/g, "") + " (DASH video)", c.format_note = "DASH video") : [139, 140, 141, 171, 172].indexOf(e) > -1 && (c.format = c.format.replace(/\s*\(.+?\)/g, ""), c.format_note = "DASH audio"), c.formattedSize = measureSize(c.filesize) || "--", c.formattedQuality = formatQuality(c), c.videoAudioQuality = c.height ? c.height + "p" : c.abr ? c.abr + "Kbps" : "Unknown", c.downloadName = b._filename || b.title + "." + (c.ext || b.ext);
      var d=c.url.replace(/\?.+/,"").match("[^/]+?$");
    };

    function sortFormats(a) {
      function b(a,b){
        return a||b?a&&b?a===b?0:b>a?1:-1:a?-1:1:0
      }
      for(var c=["mp4","flv","webm","3gp","m4a"],d=a.length-1;d>=0;d--){
        var e=a[d],f=e.format_note;
        if("DASH video"!==f){
          var g=e.protocol;
          if(/m3u8|hls|native|rtmp|rtsp|f4m/.test(g)){
            a.splice(d,1);
          }
          else if(g||!/m3u8|hls|native|rtmp/.test(e.format)){
            var h=e.url,i=/^https?:/.test(h),j=h.replace(/\?.+/,"").match(/\.\w+$/),k=j?j[1]:"";g||e.format||i&&"m3u8"!==k&&"f4m"!==k||a.splice(d,1)
          }
          else a.splice(d,1)
        }
        else a.splice(d,1)
      }    
      a.sort(function(a,d){
        var e=c.indexOf(a.ext),f=c.indexOf(d.ext);
        
        if(e!==f)return-1===e?1:-1===f?-1:e-f;
        
        var g=b(a.ext,d.ext);
        if(g)return g;
        var g=b(a.width,d.width);
        if(g)return g;
        if("DASH audio"===a.format_note){
          var g=b(a.abr,d.abr);if(g)return g
        }
        var g=b(a.filesize,d.filesize);
        return g?g:void 0; 
      })
    };
*/
  </script>

  <script>
  $(document).ready(function () {
      let theResource = "https://www.safaribooksonline.com/videos/drupal-7-development/39062IMP00001/39062IMP00001-16-2014-10-24";

      // video
      // course
      fetchVideoContents.runAjax(theResource,"video");
    });
  </script>
</body>
</html>